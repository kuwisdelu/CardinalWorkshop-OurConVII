---
title: "Class comparison for MSI experiments with Cardinal"
author: "Kylie Ariel Bemis"
date: "Revised: October 27, 2019"
output:
  BiocStyle::html_document:
  toc: true
vignette: >
  %\VignetteIndexEntry{Class comparision: Statistical testing workflow}
  %\VignetteKeyword{ExperimentData, MassSpectrometryData, ImagingMassSpectrometry, Regression}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
  ```{r style, echo=FALSE, results='asis'}
BiocStyle::markdown()
```

```{r setup, echo=FALSE, message=FALSE}
library(CardinalWorkflows)
register(SerialParam())
options(Cardinal.verbose=FALSE)
options(Cardinal.progress=FALSE)
RNGkind("L'Ecuyer-CMRG")
```

# Introduction 
The renal cell carcinoma (RCC) cancer dataset consisting of 8 matched pairs of human kidney tissue. Each tissue pair consists of a normal tissue sample and a cancerous tissue sample. The histological images of these samples are shown in below:

```{r}
library("imager")
files <- list.files(path = "img", pattern = "^[r]", full.names=TRUE)
all_im <- lapply(files, load.image )
par(mfrow=c(2,4))
for (i in 1:8)
{
  plot(all_im[[i]])
}
```

# Statistical testing for a renal cell carcinoma (RCC) cancer dataset

Statistical testing is performed to find m/z features differentially abundant among different groups. For the RCC cancer dataset, the goal is to find m/z features differentially abundant between normal and cancer tissue so that we can better understand the chemical signature of RCC.
## Pre-processing

Before fitting any statistical model, pre-processing is necessary to remove noise, unwanted peaks and data variance.The pre-processing steps are shown below:
```{r}
data(rcc)
rcc<-as(rcc,"MSImagingExperiment")

rcc$sample<-run(rcc)
##############preprocess
rcc.processed<-rcc %>%
  normalize(method="tic")%>%
  #reduceBaseline()%>%
  peakPick(method = "simple", SNR=10)%>%
  peakAlign()%>%
  peakFilter()%>%
  process()

rcc.peaks<-rcc%>%
  normalize(method="tic")%>%
  #reduceBaseline()%>%
  peakBin(mz(rcc.processed)) %>%
  process()

```

After pre-processing, we can check the number of remaining peaks and visualize ion images of interest.

```{r}
###########check dimension
dim(rcc.peaks)

#####visualize
image(rcc.peaks,mz=810)
```

The following code is to split the sample into two parts - cancer and normal and label each pixel using variable "diagnosis":
```{r}

cutoff<-c(35,23,28,39,29,28,44,32)
rcc.peaks$diagnosis<-"normal"
for (i in 1:length(unique(run(rcc.peaks))))
{
  rcc.peaks$diagnosis[(run(rcc.peaks)==unique(run(rcc.peaks))[i])&(coord(rcc.peaks)$x<cutoff[i])]<-"cancer"
  
}

run(rcc.peaks)<-as.factor(paste0(rcc.peaks$sample,'-', rcc.peaks$diagnosis))
####visualize

image(rcc.peaks, diagnosis~x*y, layout=c(2,4))

```


### Non-specific filtering to reduce data size

```{r}
#rcc.peaks<-rcc.peaks[78:86,]


```

### Segmentation with spatial Dirichlet Gaussian mixture model (DGMM)
Spatial-DGMM detects ion-specific tissue components with homogeneous spatial composition. It can estimate the number of Gaussian components and the mean and variance of each Gaussian component. It analyzes one m/z feature, one sample at a time.For example, we can visualize ion image of the 86th m/z feature for cancer tissue of the last sample:
```{r}
f<-86
rcc.sub<-rcc.peaks[,run(rcc.peaks)==unique(run(rcc.peaks))[16]]
image(rcc.sub, feature=f, main=paste0("m/z=", mz(rcc.sub)[f]))
      
```

Then we fit spatial-DGMM on this single ion image:

```{r}
dgmm<-spatialDGMM(rcc.sub[f,],r=1,k=4)

summary(dgmm)

image(dgmm)
```


## Visualization

## Class comparison with means-based testing


### Fitting models with means-summarized groups

```{r}
rcc.peaks.subset<-rcc.peaks[1:8,]
mtest <- meansTest(rcc.peaks.subset, ~ diagnosis, groups=run(rcc.peaks.subset))

summary(mtest)

```


### Interpreting the results

## Class comparison with segmentation-based testing

### Fitting models with spatial-DGMM-summarized groups
```{r}
dgmm2<-spatialDGMM(rcc.peaks[2:5,],r=1,k=4,groups=run(rcc.peaks))

stest<-segmentationTest(dgmm2, ~diagnosis, classControl = "Ymax")

summary(stest)
```

### Interpreting the results

# Additional uses for spatial DGMM segmentations

# Session information

```{r session-info}
sessionInfo()
```



